const SYMBOLS="pnbrqkPNBRQK",DEFAULT_POSITION="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",TERMINATION_MARKERS=["1-0","0-1","1/2-1/2","*"],PAWN_OFFSETS={b:[16,32,17,15],w:[-16,-32,-17,-15]},PIECE_OFFSETS={n:[-18,-33,-31,-14,18,33,31,14],b:[-17,-15,17,15],r:[-16,1,16,-1],q:[-17,-16,-15,1,17,16,15,-1],k:[-17,-16,-15,1,17,16,15,-1]},ATTACKS=[20,0,0,0,0,0,0,24,0,0,0,0,0,0,20,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,24,24,24,24,24,24,56,0,56,24,24,24,24,24,24,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,20,0,0,0,0,0,0,24,0,0,0,0,0,0,20],RAYS=[17,0,0,0,0,0,0,16,0,0,0,0,0,0,15,0,0,17,0,0,0,0,0,16,0,0,0,0,0,15,0,0,0,0,17,0,0,0,0,16,0,0,0,0,15,0,0,0,0,0,0,17,0,0,0,16,0,0,0,15,0,0,0,0,0,0,0,0,17,0,0,16,0,0,15,0,0,0,0,0,0,0,0,0,0,17,0,16,0,15,0,0,0,0,0,0,0,0,0,0,0,0,17,16,15,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,-15,-16,-17,0,0,0,0,0,0,0,0,0,0,0,0,-15,0,-16,0,-17,0,0,0,0,0,0,0,0,0,0,-15,0,0,-16,0,0,-17,0,0,0,0,0,0,0,0,-15,0,0,0,-16,0,0,0,-17,0,0,0,0,0,0,-15,0,0,0,0,-16,0,0,0,0,-17,0,0,0,0,-15,0,0,0,0,0,-16,0,0,0,0,0,-17,0,0,-15,0,0,0,0,0,0,-16,0,0,0,0,0,0,-17],SHIFTS={p:0,n:1,b:2,r:3,q:4,k:5},BITS={NORMAL:1,CAPTURE:2,BIG_PAWN:4,EP_CAPTURE:8,PROMOTION:16,KSIDE_CASTLE:32,QSIDE_CASTLE:64},RANK_1=7,RANK_2=6,RANK_3=5,RANK_4=4,RANK_5=3,RANK_6=2,RANK_7=1,RANK_8=0,SQUARE_MAP={a8:0,b8:1,c8:2,d8:3,e8:4,f8:5,g8:6,h8:7,a7:16,b7:17,c7:18,d7:19,e7:20,f7:21,g7:22,h7:23,a6:32,b6:33,c6:34,d6:35,e6:36,f6:37,g6:38,h6:39,a5:48,b5:49,c5:50,d5:51,e5:52,f5:53,g5:54,h5:55,a4:64,b4:65,c4:66,d4:67,e4:68,f4:69,g4:70,h4:71,a3:80,b3:81,c3:82,d3:83,e3:84,f3:85,g3:86,h3:87,a2:96,b2:97,c2:98,d2:99,e2:100,f2:101,g2:102,h2:103,a1:112,b1:113,c1:114,d1:115,e1:116,f1:117,g1:118,h1:119},ROOKS={w:[{square:SQUARE_MAP.a1,flag:BITS.QSIDE_CASTLE},{square:SQUARE_MAP.h1,flag:BITS.KSIDE_CASTLE}],b:[{square:SQUARE_MAP.a8,flag:BITS.QSIDE_CASTLE},{square:SQUARE_MAP.h8,flag:BITS.KSIDE_CASTLE}]},PARSER_STRICT=0,PARSER_SLOPPY=1;function get_disambiguator(e,r){for(var n=e.from,t=e.to,o=e.piece,i=0,a=0,l=0,f=0,u=r.length;f<u;f++){var c=r[f].from,s=r[f].to;o===r[f].piece&&n!==c&&t===s&&(i++,rank(n)===rank(c)&&a++,file(n)===file(c)&&l++)}return 0<i?0<a&&0<l?algebraic(n):0<l?algebraic(n).charAt(1):algebraic(n).charAt(0):""}function infer_piece_type(e){var r=e.charAt(0);return"a"<=r&&r<="h"?e.match(/[a-h]\d.*[a-h]\d/)?void 0:PAWN:"o"===(r=r.toLowerCase())?KING:r}function stripped_san(e){return e.replace(/=/,"").replace(/[+#]?[?!]*$/,"")}function rank(e){return e>>4}function file(e){return 15&e}function algebraic(e){var r=file(e);e=rank(e);return"abcdefgh".substring(r,r+1)+"87654321".substring(e,e+1)}function swap_color(e){return e===WHITE?BLACK:WHITE}function is_digit(e){return-1!=="0123456789".indexOf(e)}function clone(e){var r,n=e instanceof Array?[]:{};for(r in e)n[r]="object"==typeof r?clone(e[r]):e[r];return n}function trim(e){return e.replace(/^\s+|\s+$/g,"")}const BLACK="b",WHITE="w",EMPTY=-1,PAWN="p",KNIGHT="n",BISHOP="b",ROOK="r",QUEEN="q",KING="k",SQUARES=function(){for(var e=[],r=SQUARE_MAP.a8;r<=SQUARE_MAP.h1;r++)136&r?r+=7:e.push(algebraic(r));return e}(),FLAGS={NORMAL:"n",CAPTURE:"c",BIG_PAWN:"b",EP_CAPTURE:"e",PROMOTION:"p",KSIDE_CASTLE:"k",QSIDE_CASTLE:"q"},Chess=function(e){var r=new Array(128),n={w:-1,b:-1},t=WHITE,o={w:0,b:0},i=-1,a=0,l=1,f=[],u={},c={};function s(e){void 0===e&&(e=!1),r=new Array(128),n={w:-1,b:-1},t=WHITE,o={w:0,b:0},i=-1,a=0,l=1,f=[],e||(u={}),c={},h(g())}function p(){function e(e){e in c&&(n[e]=c[e])}for(var r=[],n={};0<f.length;)r.push(y());for(e(g());0<r.length;)K(r.pop()),e(g());c=n}function S(){A(DEFAULT_POSITION)}function A(e,r){void 0===r&&(r=!1);var n=e.split(/\s+/),f=n[0],u=0;if(!E(e).valid)return!1;s(r);for(var c=0;c<f.length;c++){var p,S=f.charAt(c);"/"===S?u+=8:is_digit(S)?u+=parseInt(S,10):(p=S<"a"?WHITE:BLACK,I({type:S.toLowerCase(),color:p},algebraic(u)),u++)}return t=n[1],-1<n[2].indexOf("K")&&(o.w|=BITS.KSIDE_CASTLE),-1<n[2].indexOf("Q")&&(o.w|=BITS.QSIDE_CASTLE),-1<n[2].indexOf("k")&&(o.b|=BITS.KSIDE_CASTLE),-1<n[2].indexOf("q")&&(o.b|=BITS.QSIDE_CASTLE),i="-"===n[3]?-1:SQUARE_MAP[n[3]],a=parseInt(n[4],10),l=parseInt(n[5],10),h(g()),!0}function E(e){if(6!==(e=e.split(/\s+/)).length)return{valid:!1,error_number:1,error:"FEN string must contain six space-delimited fields."};if(isNaN(parseInt(e[5]))||parseInt(e[5],10)<=0)return{valid:!1,error_number:2,error:"6th field (move number) must be a positive integer."};if(isNaN(parseInt(e[4]))||parseInt(e[4],10)<0)return{valid:!1,error_number:3,error:"5th field (half move counter) must be a non-negative integer."};if(!/^(-|[abcdefgh][36])$/.test(e[3]))return{valid:!1,error_number:4,error:"4th field (en-passant square) is invalid."};if(!/^(KQ?k?q?|Qk?q?|kq?|q|-)$/.test(e[2]))return{valid:!1,error_number:5,error:"3rd field (castling availability) is invalid."};if(!/^(w|b)$/.test(e[1]))return{valid:!1,error_number:6,error:"2nd field (side to move) is invalid."};var r=e[0].split("/");if(8!==r.length)return{valid:!1,error_number:7,error:"1st field (piece positions) does not contain 8 '/'-delimited rows."};for(var n=0;n<r.length;n++){for(var t=0,o=!1,i=0;i<r[n].length;i++)if(isNaN(r[n][i])){if(!/^[prnbqkPRNBQK]$/.test(r[n][i]))return{valid:!1,error_number:9,error:"1st field (piece positions) is invalid [invalid piece]."};t+=1,o=!1}else{if(o)return{valid:!1,error_number:8,error:"1st field (piece positions) is invalid [consecutive numbers]."};t+=parseInt(r[n][i],10),o=!0}if(8!==t)return{valid:!1,error_number:10,error:"1st field (piece positions) is invalid [row too large]."}}return"3"==e[3][1]&&"w"==e[1]||"6"==e[3][1]&&"b"==e[1]?{valid:!1,error_number:11,error:"Illegal en-passant square"}:{valid:!0,error_number:0,error:"No errors."}}function g(){for(var e,n,f=0,u="",c=SQUARE_MAP.a8;c<=SQUARE_MAP.h1;c++)null==r[c]?f++:(0<f&&(u+=f,f=0),e=r[c].color,n=r[c].type,u+=e===WHITE?n.toUpperCase():n.toLowerCase()),c+1&136&&(0<f&&(u+=f),c!==SQUARE_MAP.h1&&(u+="/"),f=0,c+=8);var s="",p=(o[WHITE]&BITS.KSIDE_CASTLE&&(s+="K"),o[WHITE]&BITS.QSIDE_CASTLE&&(s+="Q"),o[BLACK]&BITS.KSIDE_CASTLE&&(s+="k"),o[BLACK]&BITS.QSIDE_CASTLE&&(s+="q"),s=s||"-",-1===i?"-":algebraic(i));return[u,t,s,p,a,l].join(" ")}function _(e){for(var r=0;r<e.length;r+=2)"string"==typeof e[r]&&"string"==typeof e[r+1]&&(u[e[r]]=e[r+1]);return u}function h(e){0<f.length||(e!==DEFAULT_POSITION?(u.SetUp="1",u.FEN=e):(delete u.SetUp,delete u.FEN))}function T(e){return(e=r[SQUARE_MAP[e]])?{type:e.type,color:e.color}:null}function I(e,t){return"type"in e&&"color"in e&&(-1!==SYMBOLS.indexOf(e.type.toLowerCase())&&(t in SQUARE_MAP&&(t=SQUARE_MAP[t],(e.type!=KING||-1==n[e.color]||n[e.color]==t)&&(r[t]={type:e.type,color:e.color},e.type===KING&&(n[e.color]=t),h(g()),!0))))}function v(e,r,n,o,i){return r={color:t,from:r,to:n,flags:o,piece:e[r].type},i&&(r.flags|=BITS.PROMOTION,r.promotion=i),e[n]?r.captured=e[n].type:o&BITS.EP_CAPTURE&&(r.captured=PAWN),r}function R(e){function a(e,r,n,t,o){if(e[n].type!==PAWN||0!==rank(t)&&7!==rank(t))r.push(v(e,n,t,o));else for(var i=["q","r","b","n"],a=0,l=i.length;a<l;a++)r.push(v(e,n,t,o,i[a]))}var l=[],f=t,u=swap_color(f),c={b:1,w:6},s=SQUARE_MAP.a8,p=SQUARE_MAP.h1,S=!1,A=!(void 0!==e&&"legal"in e)||e.legal,E=!(void 0!==e&&"piece"in e&&"string"==typeof e.piece)||e.piece.toLowerCase();if(void 0!==e&&"square"in e){if(!(e.square in SQUARE_MAP))return[];s=p=SQUARE_MAP[e.square],S=!0}for(var g,_,h=s;h<=p;h++)if(136&h)h+=7;else{var T=r[h];if(null!=T&&T.color===f)if(T.type!==PAWN||!0!==E&&E!==PAWN){if(!0===E||E===T.type)for(var I=0,R=PIECE_OFFSETS[T.type].length;I<R;I++)for(var d=PIECE_OFFSETS[T.type][I],m=h;!(136&(m+=d));){if(null!=r[m]){if(r[m].color===f)break;a(r,l,h,m,BITS.CAPTURE);break}if(a(r,l,h,m,BITS.NORMAL),"n"===T.type||"k"===T.type)break}}else{m=h+PAWN_OFFSETS[f][0];for(null==r[m]&&(a(r,l,h,m,BITS.NORMAL),m=h+PAWN_OFFSETS[f][1],c[f]===rank(h)&&null==r[m]&&a(r,l,h,m,BITS.BIG_PAWN)),I=2;I<4;I++)136&(m=h+PAWN_OFFSETS[f][I])||(null!=r[m]&&r[m].color===u?a(r,l,h,m,BITS.CAPTURE):m===i&&a(r,l,h,i,BITS.EP_CAPTURE))}}if(!0!==E&&E!==KING||S&&p!==n[f]||(o[f]&BITS.KSIDE_CASTLE&&(_=(g=n[f])+2,null!=r[g+1]||null!=r[_]||b(u,n[f])||b(u,g+1)||b(u,_)||a(r,l,n[f],_,BITS.KSIDE_CASTLE)),o[f]&BITS.QSIDE_CASTLE&&(_=(g=n[f])-2,null!=r[g-1]||null!=r[g-2]||null!=r[g-3]||b(u,n[f])||b(u,g-1)||b(u,_)||a(r,l,n[f],_,BITS.QSIDE_CASTLE))),!A)return l;var C=[];for(h=0,R=l.length;h<R;h++)K(l[h]),P(f)||C.push(l[h]),y();return C}function d(e,r){var n="";return e.flags&BITS.KSIDE_CASTLE?n="O-O":e.flags&BITS.QSIDE_CASTLE?n="O-O-O":(e.piece!==PAWN&&(r=get_disambiguator(e,r),n+=e.piece.toUpperCase()+r),e.flags&(BITS.CAPTURE|BITS.EP_CAPTURE)&&(e.piece===PAWN&&(n+=algebraic(e.from)[0]),n+="x"),n+=algebraic(e.to),e.flags&BITS.PROMOTION&&(n+="="+e.promotion.toUpperCase())),K(e),m()&&(C()?n+="#":n+="+"),y(),n}function b(e,n){for(var t=SQUARE_MAP.a8;t<=SQUARE_MAP.h1;t++)if(136&t)t+=7;else if(null!=r[t]&&r[t].color===e){var o=r[t],i=t-n,a=119+i;if(ATTACKS[a]&1<<SHIFTS[o.type])if(o.type===PAWN){if(0<i){if(o.color===WHITE)return!0}else if(o.color===BLACK)return!0}else{if("n"===o.type||"k"===o.type)return!0;for(var l=RAYS[a],f=t+l,u=!1;f!==n;){if(null!=r[f]){u=!0;break}f+=l}if(!u)return!0}}return!1}function P(e){return b(swap_color(e),n[e])}function m(){return P(t)}function C(){return m()&&0===R().length}function O(){return!m()&&0===R().length}function N(){for(var e={},n=[],t=0,o=0,i=SQUARE_MAP.a8;i<=SQUARE_MAP.h1;i++){var a;o=(o+1)%2;136&i?i+=7:(a=r[i])&&(e[a.type]=a.type in e?e[a.type]+1:1,"b"===a.type&&n.push(o),t++)}if(2===t)return!0;if(3===t&&(1===e.b||1===e.n))return!0;if(t===e.b+2){var l=0,f=n.length;for(i=0;i<f;i++)l+=n[i];if(0===l||l===f)return!0}return!1}function B(){for(var e=[],r={},n=!1;;){var t=y();if(!t)break;e.push(t)}for(;;){var o=g().split(" ").slice(0,4).join(" ");if(r[o]=o in r?r[o]+1:1,3<=r[o]&&(n=!0),!e.length)break;K(e.pop())}return n}function K(e){var u,c,s=t,p=swap_color(s);if(f.push({move:e,kings:{b:n.b,w:n.w},turn:t,castling:{b:o.b,w:o.w},ep_square:i,half_moves:a,move_number:l}),r[e.to]=r[e.from],r[e.from]=null,e.flags&BITS.EP_CAPTURE&&(t===BLACK?r[e.to-16]=null:r[e.to+16]=null),e.flags&BITS.PROMOTION&&(r[e.to]={type:e.promotion,color:s}),r[e.to].type===KING&&(n[r[e.to].color]=e.to,e.flags&BITS.KSIDE_CASTLE?(u=e.to-1,c=e.to+1,r[u]=r[c],r[c]=null):e.flags&BITS.QSIDE_CASTLE&&(u=e.to+1,c=e.to-2,r[u]=r[c],r[c]=null),o[s]=""),o[s])for(var S=0,A=ROOKS[s].length;S<A;S++)if(e.from===ROOKS[s][S].square&&o[s]&ROOKS[s][S].flag){o[s]^=ROOKS[s][S].flag;break}if(o[p])for(S=0,A=ROOKS[p].length;S<A;S++)if(e.to===ROOKS[p][S].square&&o[p]&ROOKS[p][S].flag){o[p]^=ROOKS[p][S].flag;break}i=e.flags&BITS.BIG_PAWN?"b"===t?e.to-16:e.to+16:-1,e.piece===PAWN||e.flags&(BITS.CAPTURE|BITS.EP_CAPTURE)?a=0:a++,t===BLACK&&l++,t=swap_color(t)}function y(){if(null==(s=f.pop()))return null;var e,u,c=s.move,s=(n=s.kings,t=s.turn,o=s.castling,i=s.ep_square,a=s.half_moves,l=s.move_number,t),p=swap_color(t);return r[c.from]=r[c.to],r[c.from].type=c.piece,r[c.to]=null,c.flags&BITS.CAPTURE?r[c.to]={type:c.captured,color:p}:c.flags&BITS.EP_CAPTURE&&(s=s===BLACK?c.to-16:c.to+16,r[s]={type:PAWN,color:p}),c.flags&(BITS.KSIDE_CASTLE|BITS.QSIDE_CASTLE)&&(c.flags&BITS.KSIDE_CASTLE?(e=c.to+1,u=c.to-1):c.flags&BITS.QSIDE_CASTLE&&(e=c.to-2,u=c.to+1),r[e]=r[u],r[u]=null),c}function L(e,r){for(var n=stripped_san(e),t=0;t<2;t++){if(1==t){if(!r)return null;var o,i,a,l,f=!1,u=n.match(/([pnbrqkPNBRQK])?([a-h][1-8])x?-?([a-h][1-8])([qrbnQRBN])?/);(u=u||n.match(/([pnbrqkPNBRQK])?([a-h]?[1-8]?)x?-?([a-h][1-8])([qrbnQRBN])?/))&&(o=u[1],i=u[2],a=u[3],l=u[4],1==i.length&&(f=!0))}for(var c=infer_piece_type(n),s=R({legal:!0,piece:o||c}),p=0,S=s.length;p<S;p++)switch(t){case 0:if(n===stripped_san(d(s[p],s)))return s[p];break;case 1:if(u){if(!(o&&o.toLowerCase()!=s[p].piece||SQUARE_MAP[i]!=s[p].from||SQUARE_MAP[a]!=s[p].to||l&&l.toLowerCase()!=s[p].promotion))return s[p];if(f){var A=algebraic(s[p].from);if(!(o&&o.toLowerCase()!=s[p].piece||SQUARE_MAP[a]!=s[p].to||i!=A[0]&&i!=A[1]||l&&l.toLowerCase()!=s[p].promotion))return s[p]}}}}return null}function U(e){var r,n=clone(e),t=(n.san=d(n,R({legal:!0})),n.to=algebraic(n.to),n.from=algebraic(n.from),"");for(r in BITS)BITS[r]&n.flags&&(t+=FLAGS[r]);return n.flags=t,n}return A(void 0===e?DEFAULT_POSITION:e),{load:function(e){return A(e)},reset:S,moves:function(e){for(var r=R(e),n=[],t=0,o=r.length;t<o;t++)void 0!==e&&"verbose"in e&&e.verbose?n.push(U(r[t])):n.push(d(r[t],R({legal:!0})));return n},in_check:m,in_checkmate:C,in_stalemate:O,in_draw:function(){return 100<=a||O()||N()||B()},insufficient_material:N,in_threefold_repetition:B,game_over:function(){return 100<=a||C()||O()||N()||B()},validate_fen:E,fen:g,board:function(){for(var e=[],n=[],t=SQUARE_MAP.a8;t<=SQUARE_MAP.h1;t++)null==r[t]?n.push(null):n.push({square:algebraic(t),type:r[t].type,color:r[t].color}),t+1&136&&(e.push(n),n=[],t+=8);return e},pgn:function(e){var r="object"==typeof e&&"string"==typeof e.newline_char?e.newline_char:"\n",n="object"==typeof e&&"number"==typeof e.max_width?e.max_width:0,t=[],o=!1;for(h in u)t.push("["+h+' "'+u[h]+'"]'+r),o=!0;function i(e){var r=c[g()];return void 0!==r?e+(0<e.length?" ":"")+`{${r}}`:e}o&&f.length&&t.push(r);for(var a=[];0<f.length;)a.push(y());var s=[],p="";for(0===a.length&&s.push(i(""));0<a.length;){p=i(p);var S,A=a.pop();f.length||"b"!==A.color?"w"===A.color&&(p.length&&s.push(p),p=l+"."):(S=l+". ...",p=p?p+" "+S:S),p=p+" "+d(A,R({legal:!0})),K(A)}if(p.length&&s.push(i(p)),void 0!==u.Result&&s.push(u.Result),0===n)return t.join("")+s.join(" ");for(var E=function(){return 0<t.length&&" "===t[t.length-1]&&(t.pop(),!0)},_=0,h=0;h<s.length;h++)_+s[h].length>n&&s[h].includes("{")?_=function(e,o){for(var i of o.split(" "))if(i){if(e+i.length>n){for(;E();)e--;t.push(r),e=0}t.push(i),e+=i.length,t.push(" "),e++}return E()&&e--,e}(_,s[h]):(_+s[h].length>n&&0!==h?(" "===t[t.length-1]&&t.pop(),t.push(r),_=0):0!==h&&(t.push(" "),_++),t.push(s[h]),_+=s[h].length);return t.join("")},load_pgn:function(e,r){var n=void 0!==r&&"sloppy"in r&&r.sloppy;function t(e){return e.replace(/\\/g,"\\")}e=e.trim();var o,i="object"==typeof r&&"string"==typeof r.newline_char?r.newline_char:"\r?\n",a=(a=new RegExp("^(\\[((?:"+t(i)+")|.)*\\])(?:\\s*"+t(i)+"){2}")).test(e)?a.exec(e)[1]:"",l=(S(),function(e,r){r="object"==typeof r&&"string"==typeof r.newline_char?r.newline_char:"\r?\n";for(var n={},o=e.split(new RegExp(t(r))),i=0;i<o.length;i++){var a=/^\s*\[([A-Za-z]+)\s*"(.*)"\s*\]\s*$/,l=o[i].replace(a,"$1");a=o[i].replace(a,"$2");0<trim(l).length&&(n[l]=a)}return n}(a,r)),f="";for(o in l)"fen"===o.toLowerCase()&&(f=l[o]),_([o,l[o]]);if(n){if(f&&!A(f,!0))return!1}else if(!("1"!==l.SetUp||"FEN"in l&&A(l.FEN,!0)))return!1;function s(e){return e=e.replace(new RegExp(t(i),"g")," "),`{${p(e.slice(1,e.length-1))}}`}for(var p=function(e){return Array.from(e).map((function(e){return e.charCodeAt(0)<128?e.charCodeAt(0).toString(16):encodeURIComponent(e).replace(/\%/g,"").toLowerCase()})).join("")},E=function(e){return 0==e.length?"":decodeURIComponent("%"+e.match(/.{1,2}/g).join("%"))},h=e.replace(a,"").replace(new RegExp(`({[^}]*})+?|;([^${t(i)}]*)`,"g"),(function(e,r,n){return void 0!==r?s(r):" "+s(`{${n.slice(1)}}`)})).replace(new RegExp(t(i),"g")," "),T=/(\([^\(\)]+\))+?/g;T.test(h);)h=h.replace(T,"");for(var I=(I=trim(h=(h=(h=h.replace(/\d+\.(\.\.)?/g,"")).replace(/\.\.\./g,"")).replace(/\$\d+/g,"")).split(new RegExp(/\s+/))).join(",").replace(/,,+/g,",").split(","),v="",R=0;R<I.length;R++){var d=function(e){if(e.startsWith("{")&&e.endsWith("}"))return E(e.slice(1,e.length-1))}(I[R]);if(void 0!==d)c[g()]=d;else if(null==(d=L(I[R],n))){if(!(-1<TERMINATION_MARKERS.indexOf(I[R])))return!1;v=I[R]}else v="",K(d)}return v&&Object.keys(u).length&&!u.Result&&_(["Result",v]),!0},header:function(){return _(arguments)},turn:function(){return t},move:function(e,r){r=void 0!==r&&"sloppy"in r&&r.sloppy;var n=null;if("string"==typeof e)n=L(e,r);else if("object"==typeof e)for(var t=R(),o=0,i=t.length;o<i;o++)if(!(e.from!==algebraic(t[o].from)||e.to!==algebraic(t[o].to)||"promotion"in t[o]&&e.promotion!==t[o].promotion)){n=t[o];break}return n?(r=U(n),K(n),r):null},undo:function(){var e=y();return e?U(e):null},clear:function(){return s()},put:I,get:T,ascii(){for(var e,n="   +------------------------+\n",t=SQUARE_MAP.a8;t<=SQUARE_MAP.h1;t++)0===file(t)&&(n+=" "+"87654321"[rank(t)]+" |"),null==r[t]?n+=" . ":(e=r[t].type,n+=" "+(r[t].color===WHITE?e.toUpperCase():e.toLowerCase())+" "),t+1&136&&(n+="|\n",t+=8);return n+"   +------------------------+\n     a  b  c  d  e  f  g  h"},remove:function(e){return t=T(e=e),r[SQUARE_MAP[e]]=null,t&&t.type===KING&&(n[t.color]=-1),h(g()),t;var t},perft:function e(r){for(var n=R({legal:!1}),o=0,i=t,a=0,l=n.length;a<l;a++)K(n[a]),P(i)||(0<r-1?o+=e(r-1):o++),y();return o},square_color:function(e){return e in SQUARE_MAP?(rank(e=SQUARE_MAP[e])+file(e))%2==0?"light":"dark":null},history:function(e){for(var r=[],n=[],t=(void 0!==e&&"verbose"in e&&e.verbose);0<f.length;)r.push(y());for(;0<r.length;){var o=r.pop();t?n.push(U(o)):n.push(d(o,R({legal:!0}))),K(o)}return n},get_comment:function(){return c[g()]},set_comment:function(e){c[g()]=e.replace("{","[").replace("}","]")},delete_comment:function(){var e=c[g()];return delete c[g()],e},get_comments:function(){return p(),Object.keys(c).map((function(e){return{fen:e,comment:c[e]}}))},delete_comments:function(){return p(),Object.keys(c).map((function(e){var r=c[e];return delete c[e],{fen:e,comment:r}}))}}};export{BLACK,WHITE,EMPTY,PAWN,KNIGHT,BISHOP,ROOK,QUEEN,KING,SQUARES,FLAGS,Chess};